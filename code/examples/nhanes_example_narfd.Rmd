---
title: "NARFD Example"
author: "Bohan Wu"
date: "3/15/2021"
output: pdf_document
---
```{r}
rm(list = ls())
```
```{r setup, include=FALSE}
source(here::here("source", "Simulate_Data.R"))
source(here::here("source", "NARFD.R"))

library(tidyverse)
library(reshape2)
knitr::opts_chunk$set(
	echo = TRUE,
  cache=FALSE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```
```{r}
pckgs <-c("tableone","knitr","kableExtra", "devtools","magrittr", "survey", "mgcv","refund","rnhanesdata","ROCR","caret")
sapply(pckgs, function(x) if(!require(x,character.only=TRUE,quietly=TRUE)) {
    install.packages(x)
    require(x, character.only=TRUE)
})
rm(list=c("pckgs"))
#install_github('linxihui/NNLM')
```
This document includes a brief demonstration of the Poisson FPCA method for preprocessed "Nhanes" activity count data aggregated in 5-min intervals. The data was generated using methods included in the file "process_nhanes_data.R". 

## Example data

Observations are included in `./data/pa_nhanes_5min.RData`. These data are imported and plotted in the code chunk below.

```{r}
load(here::here("data", "pa_nhanes_5min2.RData"))

colnames(Y) <- seq(ncol(Y))
Y__m = melt(Y) %>% 
  dplyr::rename(.id = Var1, .index = Var2, .observed = value)%>%
  mutate(.id = as.factor(.id))

Y__m %>% 
  ggplot(aes(x = .index, y = .observed, group = .id)) +
  geom_line()

```
## Fit NARFD

Next we fit the proposed method using the `NARFD()` function and a pre-specified penalty sequence. In other settings, a wider range of potential penalty terms and larger number of CV folds may be more appropriate.

```{r}
Y.l<- MakeLong(t(Y))
penalty.seq <- 2 ^ c(-3, 1, 3,5)


narfd_results <- NARFD(long = Y.l, npc = 5, nbasis = 25, D = ncol(Y), type = "NARFD", periodic = FALSE, folds = 3, iter = 25,  penalty.seq = penalty.seq, verbose = TRUE)

rm(list = c('Y_m', 'Y.l'))
```

The plot below shows estimated functional prototypes.

```{r}
print(paste("optimal penalty = ",narfd_results$penalty))
narfd_results$prototypes %>% 
  ggplot(aes(x = .index, y = Value)) + 
  geom_line() + 
  facet_grid(~prototype) + 
  xlab("Time index")+
  ggtitle("NARFD Function Prototypes(Basis)")
```

Lastly we show the observed data and fitted value for one activity curve. 

```{r}
n_samples = 4
samples = sample(unique(narfd_results$pred$.id),n_samples)
p = vector("list",n_samples)
for(i in seq(n_samples)){
  dd =   narfd_results$pred %>% 
  filter(.id == samples[i])
 p[[i]] =(ggplot(data = dd, aes(x = .index, y = .pred)) + 
  geom_line() + 
  geom_point(aes(y = .observed)) +
  xlab("Time index"))+
   ggtitle(str_replace(samples[i],"IV","Subject "))
}

multiplot(p[[1]],p[[2]],p[[3]],p[[4]], cols=2)
```

```{r}
# Save the results:
#save(narfd_results, file = 'NARFD_results.RData')
```
##Prediction: ROC curves and AUC
```{r}
source(here::here("source", "NARFD_Prediction.R"))
plot(roc_ROCR,title = "ROC Curve: NARFD");abline(a=0, b=1)
print(paste0("AUC = ",round(AUC,3)))
```
##Create Table 1
```{r}
source(here::here("source", "create_table1.R"))
```
