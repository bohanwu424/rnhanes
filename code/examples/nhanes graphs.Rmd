---
title: "Nhanes Graphical Examples"
output: html_notebook
---

The following analysis is inspired by Eunho Yang et.al 2015. In particular, we will use Mixed Graphical Models(MGM) to investigate the dependency structure between Nhanes covariates. 

```{r}
#install.packages(c("mgm", "refund", "dplyr",  "tidyr", "data.table", "glmnet", "mgcv", "tibble"))
```
```{r}
rm(list=ls())
library(mgm)
library(dplyr)
library(refund)
library(tidyverse)
library(rnhanesdata)
library(qgraph)
library(reshape2)
source(here::here("source", "Helper Functions.R"))

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```
## Example data
```{r}
load(here::here("data", "pa_nhanes_5min.RData"))
```
### Combine Mortality and Predictors
```{r}
X = Mortality_2011_D %>% filter(SEQN %in% seqn$SEQN) %>% select(mortstat)%>%
  cbind(X)
```
### Extract FPC Scores, Variance
```{r}
fit.fpca_y = fpca.face(log(Y+1), npc = 5) #takes long


X_scores = fit.fpca_y$scores;colnames(X_scores) = paste("Score_",seq(5))

#Visualize FPCs
plot_F(fit.fpca_y$efunctions)
```

#Combine Demographic, Behavorial, Comorbility Covariates with FPCA Covariates
```{r}
colnames(X_e) 
X_e = cbind(X[,-seq(2,4)], X_scores);colnames(X_e)[seq(18,20)] = c("HDL Chol"," Total Chol","Blood Pressure")
```

#Type of Covariates, Level of Covariates(1 if Cts)
```{r}
type_e = c("c", "g","c",
          "c","c","c","g","c",
          "c","g","c","c","c",
          "c","c","c","c","g",
          "g","g","g","g","g",
          "g","g")

levels_e = array(1,dim = length(type_e))
levels_e[which(type_e == "c")] = apply(X_e[,which(type_e == "c")],2,function(x)length(unique(as.factor(x))))

X_e$`HDL Chol`

```
# 1) Fit Pairwise MGM
```{r}
#call mgm()
fit_k2 = mgm(data = X_e, 
              type = type_e,
              level = levels_e,
              k  = 2,lambdaSel = "CV",lambdaFolds = 10,weights = svywt,binarySign = TRUE)

# Weighted adjacency matrix
#fit_k2$pairwise$wadj

# Visualize using qgraph()
qgraph(fit_k2$pairwise$wadj,
       edge.color = fit_k2$pairwise$edgecolor,
       layout = "spring" ,
       labels =  colnames(X_e) ,label.norm = "0000000",label.cex = 2)

# 4) Predict values
pred_obj_k2 <- predict(fit_k2, X_e)

head(pred_obj_k2$predicted) # first six rows of predicted values

#CC- the proportion of correct classification (accuracy) 
#"CCmarg" returns the accuracy of the intercept/marginal model

pred_mort = pred_obj_k2$predicted[,1] # Nodewise errors
```
# 2) Prediction Using Count FPCA
## 1)FPCs: Gaussian Case

##Count FPCA
```{r}
source(here::here("source", "Simulate_Data.R"))
source(here::here("source", "NARFD.R"))
```
###NARFD Example
```{r}
load(here::here("data", "NARFD_results.RData"))
load(here::here("data", "Poisson_FPCA_results.RData"))
```
The plot below shows 3 Fit Examples from NARFD and PFPCA.
```{r}
samples = sample(narfd_results$pred$.id %>% unique(),3)

narfd_results$pred %>% 
  filter(.id %in% samples) %>% 
  ggplot(aes(x = .index, y = .pred)) + 
  geom_line() + 
  facet_grid(~.id)+ 
  geom_point(aes(y = .observed)) +
  xlab("Time index")

gfpca_results$pred %>% 
  filter(.id %in% samples) %>% 
  ggplot(aes(x = .index, y = .pred)) + 
  geom_line() + 
  facet_grid(~.id)+ 
  geom_point(aes(y = .observed)) +
  xlab("Time index")

```
```{r}
#call mgm()
fit_k3 = mgm(data = X_e, 
              type = type_e,
              level = levels_e,
              k  = 3,lambdaSel = "CV",lambdaFolds = 10,weights = svywt,binarySign = TRUE)

# Weighted adjacency matrix
#fit_k2$pairwise$wadj

# Visualize using qgraph()
qgraph(fit_k3$pairwise$wadj,
       edge.color = fit_k2$pairwise$edgecolor,
       layout = "spring" ,
       labels =  colnames(X_e) ,label.norm = "0000000",label.cex = 2
      )

```
##Predicting Mortaility
```{r}
#GLM, with survey weights
#AIC,WAIC

#Visual: 
#log-likelihood
#
#gam for mortality
```

##Bootstrap: 
```{r}
library(boot)
?boot

```
