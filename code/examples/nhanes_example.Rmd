---
title: "Poisson FPCA example"
output: html_notebook
---

```{r}
#install.packages(c("nloptr", "splines", "pbs", "refund", "dplyr", "tidyr", "data.table", "glmnet", "mgcv", "tibble"))

#library(devtools)
#install_github('linxihui/NNLM')
pckgs <- c("tableone","knitr","kableExtra",   ## packages used for creating Table 1
           "devtools",                        ## package used to download R packages stored on GitHub
           "magrittr","dplyr",                ## packages for merging/transforming data
           "survey",                          ## package used for analyzing complex survey data in R
           "mgcv","refund"                    ## packages used for smoothing/functional regression
           )

sapply(pckgs, function(x) if(!require(x,character.only=TRUE,quietly=TRUE)) {
   # install.packages(x)
    require(x, character.only=TRUE)
})
rm(list=c("pckgs"))
```
```{r setup, include=FALSE}
source(here::here("source", "Simulate_Data.R"))
source(here::here("source", "NARFD.R"))

library(tidyverse)
s
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

This document includes a brief demonstration of the Poisson FPCA method for preprocessed "Nhanes" activity count data aggregated in 5-min intervals. The data was generated using methods included in the file "process_nhanes_data.R". 

## Example data

Observations are included in `./data/pa_nhanes_5min.RData`. These data are imported and plotted in the code chunk below.

```{r}
nhanes_df = 
  load(here::here("data", "pa_nhanes_5min2.RData"))

colnames(Y) <- seq(ncol(Y))
Y__m = melt(Y[1:100,]) %>% 
  dplyr::rename(.id = Var1, .index = Var2, .observed = value)%>%
  mutate(.id = as.factor(.id))

Y__m %>% 
  ggplot(aes(x = .index, y = .observed, group = .id)) +
  geom_line()
```
## Fit PFPCA

Next we fit the proposed method using the `NARFD()` function and a pre-specified penalty sequence. In other settings, a wider range of potential penalty terms and larger number of CV folds may be more appropriate.

```{r}
Y__df <- MakeLong(t(Y))

penalty.seq <- 2 ^ c(-3, -1, 1, 3,5)

gfpca_results <- NARFD(long = Y__df, npc = 5, nbasis = 25, D = ncol(Y), type = "GFPCA", periodic = FALSE, folds = 3, iter = 25,  penalty.seq = penalty.seq, verbose = TRUE)
```

The plot below shows estimated functional prototypes.

```{r}
gfpca_results$prototypes %>% 
  ggplot(aes(x = .index, y = Value)) + 
  geom_line() + 
  facet_grid(~prototype) + 
  xlab("Time index")
```

Lastly we show the observed data and fitted value for one activity curve. 

```{r}
gfpca_results$pred %>% 
  filter(.id == "IV2") %>% 
  ggplot(aes(x = .index, y = .pred)) + 
  geom_line() + 
  geom_point(aes(y = .observed)) +
  xlab("Time index")
```

```{r}
# Save the X, Y, Ytot, tau, and the survey weights:
save(gfpca_results, file = 'Poisson_FPCA_results.RData')

```
